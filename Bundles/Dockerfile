FROM continuumio/miniconda3

RUN conda create -n MONAI python=3.10

RUN conda install -n MONAI pytorch pytorch-cuda=12.1 -c pytorch -c nvidia -y
RUN /opt/conda/envs/MONAI/bin/pip install nnunetv2 "monai[nibabel, skimage, scipy, pillow, tensorboard, gdown, ignite, torchvision, itk, tqdm, pandas, mlflow, matplotlib, pydicom]" fire

RUN apt-get update && apt-get install zip unzip -y

RUN wget https://admin.app.cloud.cbh.kth.se/minio-console/api/v1/download-shared-object/aHR0cDovL21pbmlvLm1haWEtYWRtaW4uc3ZjLmNsdXN0ZXIubG9jYWwvYXV0b3BldDI0L0F1dG9QRVRfUEVUX0NsYXNzaWZpY2F0aW9uLnppcD9YLUFtei1BbGdvcml0aG09QVdTNC1ITUFDLVNIQTI1NiZYLUFtei1DcmVkZW50aWFsPUNaMklPNTRQU0lVMExPOVhJSjJSJTJGMjAyNDA4MTclMkZ1cy1lYXN0LTElMkZzMyUyRmF3czRfcmVxdWVzdCZYLUFtei1EYXRlPTIwMjQwODE3VDA1MTczMFomWC1BbXotRXhwaXJlcz00MzIwMCZYLUFtei1TZWN1cml0eS1Ub2tlbj1leUpoYkdjaU9pSklVelV4TWlJc0luUjVjQ0k2SWtwWFZDSjkuZXlKaFkyTmxjM05MWlhraU9pSkRXakpKVHpVMFVGTkpWVEJNVHpsWVNVb3lVaUlzSW1GamNpSTZJakFpTENKaGRGOW9ZWE5vSWpvaWRtaG5OelJaVWpkdVRIVkxTV1J0U0VsNmREZDRVU0lzSW1GMVpDSTZJbTFoYVdFaUxDSmhkWFJvWDNScGJXVWlPakUzTWpNNE56QXdORGtzSW1GNmNDSTZJbTFoYVdFaUxDSmxiV0ZwYkNJNkluTnBiV0psYmtCcmRHZ3VjMlVpTENKbGJXRnBiRjkyWlhKcFptbGxaQ0k2ZEhKMVpTd2laWGh3SWpveE56SXpPVEEyTURRNExDSm1ZVzFwYkhsZmJtRnRaU0k2SWtKbGJtUmhlbnB2YkdraUxDSm5hWFpsYmw5dVlXMWxJam9pVTJsdGIyNWxJaXdpWjNKdmRYQnpJam9pVFVGSlFUcGhaRzFwYmlJc0ltbGhkQ0k2TVRjeU16ZzNNVFk1TUN3aWFYTnpJam9pYUhSMGNITTZMeTlwWVcwdVkyeHZkV1F1WTJKb0xtdDBhQzV6WlM5eVpXRnNiWE12WTJ4dmRXUWlMQ0pxZEdraU9pSmlOVFk1WWpKallTMDRNR1JrTFRSa01EQXRPVGxsWVMxaU1qWmhZelE1TTJJM1pUVWlMQ0p1WVcxbElqb2lVMmx0YjI1bElFSmxibVJoZW5wdmJHa2lMQ0p3Y21WbVpYSnlaV1JmZFhObGNtNWhiV1VpT2lKemFXMWlaVzVBYTNSb0xuTmxJaXdpYzJsa0lqb2lOek00TVRRNU1UVXRObVJpTlMwME16RTVMVGhqTVdZdFpHSmlObVl6TjJNME5qWmtJaXdpYzNWaUlqb2lOMk5oT0RBd01EZ3RZalZsWmkwMFlXSXpMV0l5TldZdFltVmtPR1EwWm1VMFkyWmpJaXdpZEhsd0lqb2lTVVFpZlEuNkVRVDlHU0hWaW5wRk9TelVNMjFZSTZjQm9hbjJZcmFacm5tekJHYmdJYlF2VTlVek4zWGIxeEdsNjdQVnhwWllna3E3ZDJKYmxmcFJxcFI0bk1vN1EmWC1BbXotU2lnbmVkSGVhZGVycz1ob3N0JnZlcnNpb25JZD1udWxsJlgtQW16LVNpZ25hdHVyZT03MzhmZGQ0NGE5YmU0OTY5NTViMWJhZDBiODFhYzM3YmM0OWMyNDk3N2IzNWI1ZDY0ZTQ1Y2M1MjAyNDUxNDM4 -O /opt/AutoPET_PET_Classification.zip
RUN unzip /opt/AutoPET_PET_Classification.zip -d /opt

RUN wget https://admin.app.cloud.cbh.kth.se/minio-console/api/v1/download-shared-object/aHR0cDovL21pbmlvLm1haWEtYWRtaW4uc3ZjLmNsdXN0ZXIubG9jYWwvYXV0b3BldDI0L0RhdGFzZXQ3MDRfQXV0b1BFVDI0Q3JvcEZERy56aXA_WC1BbXotQWxnb3JpdGhtPUFXUzQtSE1BQy1TSEEyNTYmWC1BbXotQ3JlZGVudGlhbD1TMUc4TkhDR0lXTElXTFlITlZMTiUyRjIwMjQwODE1JTJGdXMtZWFzdC0xJTJGczMlMkZhd3M0X3JlcXVlc3QmWC1BbXotRGF0ZT0yMDI0MDgxNVQxMTI2NTdaJlgtQW16LUV4cGlyZXM9NDMyMDAmWC1BbXotU2VjdXJpdHktVG9rZW49ZXlKaGJHY2lPaUpJVXpVeE1pSXNJblI1Y0NJNklrcFhWQ0o5LmV5SmhZMk5sYzNOTFpYa2lPaUpUTVVjNFRraERSMGxYVEVsWFRGbElUbFpNVGlJc0ltRmpjaUk2SWpFaUxDSmhkRjlvWVhOb0lqb2lWREJCUTA1U1IwbFJPRVJ2TlRabFJHdHhiMWhTWnlJc0ltRjFaQ0k2SW0xaGFXRWlMQ0poZFhSb1gzUnBiV1VpT2pFM01qTTNNVGsxTmpRc0ltRjZjQ0k2SW0xaGFXRWlMQ0psYldGcGJDSTZJbk5wYldKbGJrQnJkR2d1YzJVaUxDSmxiV0ZwYkY5MlpYSnBabWxsWkNJNmRISjFaU3dpWlhod0lqb3hOekl6TnpVMU5UWXpMQ0ptWVcxcGJIbGZibUZ0WlNJNklrSmxibVJoZW5wdmJHa2lMQ0puYVhabGJsOXVZVzFsSWpvaVUybHRiMjVsSWl3aVozSnZkWEJ6SWpvaVRVRkpRVHBoWkcxcGJpSXNJbWxoZENJNk1UY3lNemN4T1RVMk5Td2lhWE56SWpvaWFIUjBjSE02THk5cFlXMHVZMnh2ZFdRdVkySm9MbXQwYUM1elpTOXlaV0ZzYlhNdlkyeHZkV1FpTENKcWRHa2lPaUl6TXpJNE9EVTVPQzFoWkRFNExUUTFNV010WVRFeFl5MHlNV1l5TlRrd056VTVNakFpTENKdVlXMWxJam9pVTJsdGIyNWxJRUpsYm1SaGVucHZiR2tpTENKd2NtVm1aWEp5WldSZmRYTmxjbTVoYldVaU9pSnphVzFpWlc1QWEzUm9Mbk5sSWl3aWMybGtJam9pWTJSbU9UbGlOVGN0WVRrM05pMDBNakpqTFdFeFl6VXRORFEyTWpZelltVm1NelppSWl3aWMzVmlJam9pTjJOaE9EQXdNRGd0WWpWbFppMDBZV0l6TFdJeU5XWXRZbVZrT0dRMFptVTBZMlpqSWl3aWRIbHdJam9pU1VRaWZRLlNCTW9DQWdoLVF2RjB6RzFjMFlpQm9KWlJhOVhQNkFRcXI4MlVDYXJzOEdLcHJLUjF3R2JvUklQYjVUaTNGZzd5ZlR0OTBYbjQ3a09wQTRZeVNZOUd3JlgtQW16LVNpZ25lZEhlYWRlcnM9aG9zdCZ2ZXJzaW9uSWQ9bnVsbCZYLUFtei1TaWduYXR1cmU9OWU0MTJmZGFlMTRhZTZjNGU2YTAxNmFiNTIwOTgyMTEwODgzYWYzNThhZWNlM2FhYmFlZTE3ZDlmZTlkZDI3MA -O /opt/Dataset704_AutoPET24CropFDG.zip
RUN unzip /opt/Dataset704_AutoPET24CropFDG.zip -d /opt


RUN wget https://admin.app.cloud.cbh.kth.se/minio-console/api/v1/download-shared-object/aHR0cDovL21pbmlvLm1haWEtYWRtaW4uc3ZjLmNsdXN0ZXIubG9jYWwvYXV0b3BldDI0L0RhdGFzZXQ3MDRfQXV0b1BFVDI0Q3JvUFNNQS56aXA_WC1BbXotQWxnb3JpdGhtPUFXUzQtSE1BQy1TSEEyNTYmWC1BbXotQ3JlZGVudGlhbD1TMUc4TkhDR0lXTElXTFlITlZMTiUyRjIwMjQwODE1JTJGdXMtZWFzdC0xJTJGczMlMkZhd3M0X3JlcXVlc3QmWC1BbXotRGF0ZT0yMDI0MDgxNVQxMTM2MDlaJlgtQW16LUV4cGlyZXM9NDMyMDAmWC1BbXotU2VjdXJpdHktVG9rZW49ZXlKaGJHY2lPaUpJVXpVeE1pSXNJblI1Y0NJNklrcFhWQ0o5LmV5SmhZMk5sYzNOTFpYa2lPaUpUTVVjNFRraERSMGxYVEVsWFRGbElUbFpNVGlJc0ltRmpjaUk2SWpFaUxDSmhkRjlvWVhOb0lqb2lWREJCUTA1U1IwbFJPRVJ2TlRabFJHdHhiMWhTWnlJc0ltRjFaQ0k2SW0xaGFXRWlMQ0poZFhSb1gzUnBiV1VpT2pFM01qTTNNVGsxTmpRc0ltRjZjQ0k2SW0xaGFXRWlMQ0psYldGcGJDSTZJbk5wYldKbGJrQnJkR2d1YzJVaUxDSmxiV0ZwYkY5MlpYSnBabWxsWkNJNmRISjFaU3dpWlhod0lqb3hOekl6TnpVMU5UWXpMQ0ptWVcxcGJIbGZibUZ0WlNJNklrSmxibVJoZW5wdmJHa2lMQ0puYVhabGJsOXVZVzFsSWpvaVUybHRiMjVsSWl3aVozSnZkWEJ6SWpvaVRVRkpRVHBoWkcxcGJpSXNJbWxoZENJNk1UY3lNemN4T1RVMk5Td2lhWE56SWpvaWFIUjBjSE02THk5cFlXMHVZMnh2ZFdRdVkySm9MbXQwYUM1elpTOXlaV0ZzYlhNdlkyeHZkV1FpTENKcWRHa2lPaUl6TXpJNE9EVTVPQzFoWkRFNExUUTFNV010WVRFeFl5MHlNV1l5TlRrd056VTVNakFpTENKdVlXMWxJam9pVTJsdGIyNWxJRUpsYm1SaGVucHZiR2tpTENKd2NtVm1aWEp5WldSZmRYTmxjbTVoYldVaU9pSnphVzFpWlc1QWEzUm9Mbk5sSWl3aWMybGtJam9pWTJSbU9UbGlOVGN0WVRrM05pMDBNakpqTFdFeFl6VXRORFEyTWpZelltVm1NelppSWl3aWMzVmlJam9pTjJOaE9EQXdNRGd0WWpWbFppMDBZV0l6TFdJeU5XWXRZbVZrT0dRMFptVTBZMlpqSWl3aWRIbHdJam9pU1VRaWZRLlNCTW9DQWdoLVF2RjB6RzFjMFlpQm9KWlJhOVhQNkFRcXI4MlVDYXJzOEdLcHJLUjF3R2JvUklQYjVUaTNGZzd5ZlR0OTBYbjQ3a09wQTRZeVNZOUd3JlgtQW16LVNpZ25lZEhlYWRlcnM9aG9zdCZ2ZXJzaW9uSWQ9bnVsbCZYLUFtei1TaWduYXR1cmU9NTJjYTNiYWQ1OWI4Y2VmZWE4OTIzY2I2MWI1YjMxMzg2ZjMyNWU3YjliYmNlNjNmMmEyNzhkYzQwNDg2NzRlMQ -O /opt/Dataset704_AutoPET24CropPSMA.zip
RUN unzip /opt/Dataset704_AutoPET24CropPSMA.zip -d /opt


COPY inference.sh /opt/

COPY run_segmentation.py /opt/

CMD ["bash", "/opt/inference.sh"]
